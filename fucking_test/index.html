<!doctype html>
<html lang="en"></html>
  <head>
    <meta charset="utf-8" />

    <meta name="viewport" content_width="device-width", initial-scale="1" />

    <!-- Preconnect to the font server to speed up loading -->
    <link rel="preconnect" href="https://www.nerdfonts.com" crossorigin />

    <!-- Custom styles. -->
    <link rel="stylesheet" type="text/css" href="./styles.css" />

    <!-- Allows React to be run buildless via "text/babel" script below. -->
    <script
      src="https://unpkg.com/@babel/standalone@7.25.6/babel.min.js"
      integrity="sha256-aS0B0wnsaDByLfE16h4MDCP1fQFccysd1YWOcV+gbBo="
      crossorigin="anonymous"
    ></script>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
      import React, {
        useState,
        useEffect,
      } from 'https://esm.sh/react@18?dev';
      import { createRoot } from 'https://esm.sh/react-dom@18/client?dev';
      import * as zebar from 'https://esm.sh/zebar@3.0';

      const providers = zebar.createProviderGroup({
        cpu: { type: 'cpu' },
        battery: { type: 'battery' },
        memory: { type: 'memory' },
        weather: { type: 'weather' },
        media: { type: 'media' },
        audio: { type: 'audio' },
      });

      createRoot(document.getElementById('root')).render(<App />);

      // A component for the abstract audio visualizer
      function AudioVisualizer({ barCount = 10 }) {
        const [barHeights, setBarHeights] = useState([]);

        useEffect(() => {
          const interval = setInterval(() => {
            const newHeights = Array.from({ length: barCount }, () =>
              Math.floor(Math.random() * 20 + 2)
            );
            setBarHeights(newHeights);
          }, 120); // Slower update interval for performance (from 50ms)

          return () => clearInterval(interval); // Cleanup on unmount
        }, [barCount]);

        return (
          <div className="visualizer-container">
            {barHeights.map((height, index) => (
              <div
                key={index}
                className="visualizer-bar"
                style={{ height: `${height}px` }}
              />
            ))}
          </div>
        );
      }
      const MemoizedAudioVisualizer = React.memo(AudioVisualizer);

      // A component to display song title and artist.
      function NowPlayingInfo({ title, artist }) {
        return (
          <div className="now-playing-info">
            <div className="song-title" title={title}>
              {title}
            </div>
            {artist && (
              <div className="song-artist" title={artist}>
                {artist}
              </div>
            )}
          </div>
        );
      }
      const MemoizedNowPlayingInfo = React.memo(NowPlayingInfo);

      function App() {
        const [output, setOutput] = useState(providers.outputMap);
        const [showVolumeSlider, setShowVolumeSlider] = useState(false);
        const [volume, setVolume] = useState(
          output.audio?.defaultPlaybackDevice?.volume || 50
        );
        const [previousVolume, setPreviousVolume] = useState(volume);
        const [isDragging, setIsDragging] = useState(false);

        useEffect(() => {
          providers.onOutput(() => setOutput(providers.outputMap));
        }, []);

        useEffect(() => {
          if (!isDragging) return;

          const handleMouseMove = (e) => {
            const progressBar = document.getElementById('volume-progress');
            if (!progressBar) return;
            const rect = progressBar.getBoundingClientRect();
            const x = Math.max(0, Math.min(e.clientX - rect.left, rect.width));
            const newVolume = Math.round((x / rect.width) * 100);
            setVolume(newVolume);
            output.audio.setVolume?.(newVolume);
          };

          const handleMouseUp = () => {
            setIsDragging(false);
          };

          window.addEventListener('mousemove', handleMouseMove);
          window.addEventListener('mouseup', handleMouseUp);

          return () => {
            window.removeEventListener('mousemove', handleMouseMove);
            window.removeEventListener('mouseup', handleMouseUp);
          };
        }, [isDragging, output.audio]);

        useEffect(() => {
          if (output.audio?.defaultPlaybackDevice?.volume != null) {
            setVolume(output.audio.defaultPlaybackDevice.volume);
          }
        }, [output.audio]);

        // A component to scroll long text.
        function ScrollingText({ text }) {
          const containerRef = React.useRef(null);
          const textRef = React.useRef(null);
          const [isScrolling, setIsScrolling] = React.useState(false);

          React.useEffect(() => {
            if (
              textRef.current &&
              containerRef.current &&
              textRef.current.scrollWidth > containerRef.current.offsetWidth
            ) {
              setIsScrolling(true);
            } else {
              setIsScrolling(false);
            }
          }, [text]);

          return (
            <div className="scrolling-text-container" ref={containerRef}>
              <span
                className={isScrolling ? 'scrolling-text' : ''}
                ref={textRef}
              >
                {text}
              </span>
            </div>
          );
        }

        // Get icon to show for current network status.
        function getNetworkIcon(networkOutput) {
          switch (networkOutput.defaultInterface?.type) {
            case 'ethernet':
              return <i className="nf nf-md-ethernet_cable"></i>;
            case 'proprietary_virtual':
              return <i className="nf nf-md-shield_lock_outline"></i>;
            case 'wifi':
              if (networkOutput.defaultGateway?.signalStrength >= 80) {
                return <i className="nf nf-md-wifi_strength_4"></i>;
              } else if (
                networkOutput.defaultGateway?.signalStrength >= 65
              ) {
                return <i className="nf nf-md-wifi_strength_3"></i>;
              } else if (
                networkOutput.defaultGateway?.signalStrength >= 40
              ) {
                return <i className="nf nf-md-wifi_strength_2"></i>;
              } else if (
                networkOutput.defaultGateway?.signalStrength >= 25
              ) {
                return <i className="nf nf-md-wifi_strength_1"></i>;
              } else {
                return <i className="nf nf-md-wifi_strength_outline"></i>;
              }
            default:
              return (
                <i className="nf nf-md-wifi_strength_off_outline"></i>
              );
          }
        }

        // Get icon to show for how much of the battery is charged.
        function getBatteryIcon(batteryOutput) {
          if (batteryOutput.chargePercent > 90)
            return <i className="nf nf-fa-battery_4"></i>;
          if (batteryOutput.chargePercent > 70)
            return <i className="nf nf-fa-battery_3"></i>;
          if (batteryOutput.chargePercent > 40)
            return <i className="nf nf-fa-battery_2"></i>;
          if (batteryOutput.chargePercent > 20)
            return <i className="nf nf-fa-battery_1"></i>;
          return <i className="nf nf-fa-battery_0"></i>;
        }

        // Get icon to show for current weather status.
        function getWeatherIcon(weatherOutput) {
          switch (weatherOutput.status) {
            case 'clear_day':
              return <i className="nf nf-weather-day_sunny"></i>;
            case 'clear_night':
              return <i className="nf nf-weather-night_clear"></i>;
            case 'cloudy_day':
              return <i className="nf nf-weather-day_cloudy"></i>;
            case 'cloudy_night':
              return <i className="nf nf-weather-night_alt_cloudy"></i>;
            case 'light_rain_day':
              return <i className="nf nf-weather-day_sprinkle"></i>;
            case 'light_rain_night':
              return <i className="nf nf-weather-night_alt_sprinkle"></i>;
            case 'heavy_rain_day':
              return <i className="nf nf-weather-day_rain"></i>;
            case 'heavy_rain_night':
              return <i className="nf nf-weather-night_alt_rain"></i>;
            case 'snow_day':
              return <i className="nf nf-weather-day_snow"></i>;
            case 'snow_night':
              return <i className="nf nf-weather-night_alt_snow"></i>;
            case 'thunder_day':
              return <i className="nf nf-weather-day_lightning"></i>;
            case 'thunder_night':
              return <i className="nf nf-weather-night_alt_lightning"></i>;
          }
        }

        // Get icon to show for current volume status.
        function getVolumeIcon(volume) {
          if (volume == 0) {
            return <i className="nf nf-md-volume_off"></i>;
          } else if (volume > 0 && volume <= 50) {
            return <i className="nf nf-md-volume_medium"></i>;
          } else {
            return <i className="nf nf-md-volume_high"></i>;
          }
        }

        const activeSession =
          output.media?.allSessions?.find(
            (s) =>
              s.sourceName?.toLowerCase().includes('spotify') ||
              s.sessionId?.toLowerCase().includes('spotify')
          ) || output.media?.allSessions?.[0];

        return (
          <div className="app">
            <div className="left">
              {output.audio && (
                <div className="audio">
                  <div
                    style={{ cursor: 'pointer' }}
                    onClick={(e) => {
                      if (e.target.id !== 'volume-progress') {
                        if (volume > 0) {
                          setPreviousVolume(volume);
                          setVolume(0);
                          output.audio.setVolume?.(0);
                        } else {
                          setVolume(previousVolume);
                          output.audio.setVolume?.(previousVolume);
                        }
                      }
                    }}
                    title="Mute/Unmute"
                  >
                    {getVolumeIcon(volume)}
                    </div>
                    
                    {showVolumeSlider && (
                    <progress
                    id="volume-progress"
                      value={volume}
                      max="100"
                      onMouseDown={(e) => {
                        e.stopPropagation();
                        const rect = e.target.getBoundingClientRect();
                        const clickX = e.clientX - rect.left;
                        const newVolume = Math.round(
                          (clickX / rect.width) * 100
                        );
                        setVolume(newVolume);
                        output.audio.setVolume?.(newVolume);
                        setIsDragging(true);
                      }}
                      onMouseUp={(e) => {
                        e.stopPropagation();
                        setIsDragging(false);
                      }}
                      onClick={(e) => e.stopPropagation()}
                    />
                  )}

                  <span
                    onClick={(e) => {
                      if (e.target.id !== 'volume-progress') {
                        setShowVolumeSlider((prev) => !prev);
                      }
                    }}
                    className="volume-percentage"
                    title="Open volume slider"
                  >
                    {volume}%
                  </span>
                </div>
              )}
              </div>
              
              <div className="center"></div>
              
              <div className="right">
              {activeSession?.isPlaying && <MemoizedAudioVisualizer />}

              <div className="now-playing">
                {/* Render content conditionally inside a persistent container to improve LCP */}
                {output.media && activeSession ? (
                  <>
                    <i className="nf nf-md-music_note"></i>
                    <MemoizedNowPlayingInfo
                      title={activeSession.title}
                      artist={activeSession.artist}
                    />
                    {output.media.previous && (
                      <button
                        className="btn media-btn"
                        onClick={() => {
                          output.media.previous({
                            session_id: activeSession.sessionId,
                          });
                        }}
                        title="Previous"
                      >
                        <i className="nf nf-md-skip_previous"></i>
                      </button>
                    )}
                    {output.media.togglePlayPause && (
                      <button
                        className="btn media-btn"
                        onClick={() => {
                          output.media.togglePlayPause({
                            session_id: activeSession.sessionId,
                          });
                        }}
                        title="Play/Pause"
                      >
                        {activeSession.isPlaying ? (
                          <i className="nf nf-md-pause"></i>
                        ) : (
                          <i className="nf nf-md-play"></i>
                        )}
                      </button>
                    )}
                    {output.media.next && (
                      <button
                        className="btn media-btn"
                        onClick={() => {
                          output.media.next({
                            session_id: activeSession.sessionId,
                          });
                        }}
                        title="Next"
                      >
                        <i className="nf nf-md-skip_next"></i>
                      </button>
                    )}
                  </>
                ) : (
                  // Render a placeholder to stabilize layout
                  <div className="now-playing-info" />
                )}
              </div>

              {output.memory && (
                <div className="memory">
                  <i className="nf nf-fae-chip"></i>
                  {Math.round(output.memory.usage)}%
                </div>
              )}

              {output.cpu && (
                <div className="cpu">
                  <i className="nf nf-oct-cpu"></i>

                  {/* Change the text color if the CPU usage is high. */}
                  <span
                    className={output.cpu.usage > 85 ? 'high-usage' : ''}
                  >
                    {Math.round(output.cpu.usage)}%
                  </span>
                </div>
              )}

              {output.battery && (
                <div className="battery">
                  {/* Show icon for whether battery is charging. */}
                  {output.battery.isCharging && (
                    <i className="nf nf-md-power_plug charging-icon"></i>
                  )}
                  {getBatteryIcon(output.battery)}
                  {Math.round(output.battery.chargePercent)}%
                </div>
              )}

              {output.weather && (
                <div className="weather">
                  {getWeatherIcon(output.weather)}
                  {Math.round(output.weather.celsiusTemp)}°C
                </div>
              )}
            </div>
          </div>
        );
      }
    </script>
  </body>
</html>
